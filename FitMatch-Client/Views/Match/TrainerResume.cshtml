@{
    ViewData["Title"] = "TrainerResume";
}
<script src="https://unpkg.com/vue@3"></script>

<!-- 周曆 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

<style>
    /* 健身房模擬視窗 */
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
    }

    .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        background-color: #fff;
        width: 80%;
        max-width: 400px;
    }


    .section.bg-gray {
        background-color: #12121C;
    }

    h2,
    .card-body > .text-color {
        color: #ddd;
    }

    .no-gutters {
        background: linear-gradient(90deg, #F24B88 0%, #BD00FF 100%);
        border-radius: 5px
    }

    .star {
        width: 20px;
    }


    @@media (min-width: 1200px) {
        .trainerfilter .container {
            display: flex;
            max-width: 1800px;
            justify-content: center;
            margin: 0 auto;
        }
    }

    .trainerfilter .left {
        width: 30%;
        /* 左邊區塊的寬度 */
        display: flex;
        flex-direction: column;
    }

    .trainerfilter .course-widget {
        width: 70%;
    }

    .trainerfilter .right {
        width: 70%;
        /* 右邊區塊的寬度 */
        display: flex;
        flex-direction: column;
    }

    .trainerfilter .row {
        margin: 10px 0;
        /* 行與行之間的間隙 */
        min-width: 1200px;
    }

    .left .row {
        display: flex;
        justify-content: center;
        margin: 0 auto;
    }

    .trainerfilter .circle-container {
        width: 300px;
        /* 圓的寬度 */
        height: 300px;
        /* 圓的高度，應與寬度相同以產生完美的圓形 */
        border-radius: 50%;
        overflow: hidden;
        /* 隱藏超出的部分 */
        position: relative;
        /* 使內部的 img 元素能夠使用絕對定位 */
    }

    .trainerfilter .trainer-img {
        /* position: absolute; */
        /* 使用絕對定位來定位圖片 */
        /* left: 50%; */
        /* 從左側的50%開始，這會使圖片的左側與容器的中央對齊 */
        /* top: 50%; */
        /* 從頂部的50%開始，這會使圖片的頂部與容器的中央對齊 */
        /* transform: translate(-50%, -50%); */

        width: 100%;
        height: auto;
    }

    /* 使圖片置中 */
    .trainerfilter .form-check-input {
        margin-left: 0;
        margin-top: 10px;
    }

    .trainerfilter .form-check-label {
        margin-left: 20px;
    }


    .trainerfilter .card-title {
        position: absolute;
        top: 50px;
        left: 100px;
        font-size: 55px;
        text-shadow: 2px 2px 2px gray;
        color: #fff;
    }


    .pl-7 {
        padding-left: 7em;
    }

    .trainerfilter .coursefee {
        font-size: 20px;
    }

    .fc-232323 {
        color: #232323;
    }

    /* 我要預約 */
    .btn-1-container {
        display: flex;
        justify-content: center;
    }

    .btn-1 {
        border-radius: 4px;
        border: 2px solid #BC00FF;
        color: #ffff;
        display: inline-block;
        margin: 0 .25em;
        overflow: hidden;
        padding: 24px 60px 24px 16px;
        position: relative;
        text-decoration: none;
        line-height: 1;
        background-color: transparent;
    }

        .btn-1 .btn-content {
            font-size: 1em;
            line-height: 1.2;
            padding: 0 26px;
            position: relative;
            right: 0;
            transition: right 300ms ease;
            display: block;
            text-align: left;
        }

        .btn-1 .icon {
            border-left: 1px solid #BC00FF;
            position: absolute;
            right: 0;
            text-align: center;
            top: 50%;
            transition: all 300ms ease;
            transform: translateY(-50%);
            width: 58px;
            height: 70%;
        }

            .btn-1 .icon i {
                position: relative;
                top: 50%;
                transform: translateY(-50%);
            }

        .btn-1:after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
            background-color: #BC00FF;
            opacity: 0;
            transition: opacity 300ms ease;
        }

        .btn-1:hover .btn-content {
            right: 100%;
        }

        .btn-1:hover .icon {
            border-left: 0;
            font-size: 1.8em;
            width: 100%;
        }

        .btn-1:hover:after {
            opacity: .2;
        }

    /* 預約區塊 */
    .fc-scrollgrid {
        background-color: #12121C;
    }

    .fc-theme-standard .fc-scrollgrid,
    .fc td,
    .fc th {
        border-color: #6C7293;
    }

    .fc-col-header-cell-cushion {
        color: #fff;
    }

        .fc-col-header-cell-cushion:hover {
            color: #dbdbdb;
        }

    .fc-scrollgrid-shrink-frame {
        color: #a7a7b8;
    }

    .fc-timegrid-slot-label-cushion {
        margin-top: 10px;
    }


    .reservation table th {
        text-align: center;
        white-space: pre-line;
        /* 換行保留 */
        color: #ffff;
        font-weight: normal;
    }

    .reservation .time-cell {
        text-align: center;
        font-size: 18px;
        color: #ffff;
    }

    .reservation .btn-primary:focus {
        color: #fff;
        background-color: #BF3B6C;
        border-color: #BF3B6C;
        box-shadow: 0 0 0 .25rem #582337;
    }

    .fc-timegrid-slot-label-cushion {
        height: 40px;
    }

    .fc-day-today {
        background-color: transparent !important;
    }

    .fc-event-main {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .reservation .available {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: green;
        color: #ffff;
        outline: 2px solid green;
        border: none;
        /* 移除邊框 */
        box-shadow: none;
        /* 移除陰影 */
        /* border-color: transparent; */
        /* 將邊線顏色設為透明 */
        border-radius: 3px;
    }

    .fc-timegrid-event .fc-event-main {
        padding: 0;
    }

    .reservation .available:hover {
        background-color: rgb(1, 100, 1);
    }

    .reservation .booked {
        background-color: grey;
        pointer-events: none;
    }

    .reservation .booked {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: grey;
        color: #ffff;
        outline: 2px solid rgb(100, 100, 100);
        border: none;
        /* 移除邊框 */
        box-shadow: none;
        /* 移除陰影 */
        /* border-color: transparent; */
        /* 將邊線顏色設為透明 */
        border-radius: 3px;
    }

</style>

<!-- Page Header Start -->
<div class="container-fluid page-header py-5  wow fadeIn" data-wow-delay="0.1s">
    <div class="container text-center py-5">
        <h1 class="display-3 text-white text-uppercase mb-3 animated slideInDown">TRAINER RESUME</h1>
        <nav aria-label="breadcrumb animated slideInDown">
            <ol class="breadcrumb justify-content-center text-uppercase mb-0">
                <li class="breadcrumb-item"><a class="text-white" href="#">Home</a></li>
                <li class="breadcrumb-item"><a class="text-white" href="#">Pages</a></li>
                <li class="breadcrumb-item text-primary active" aria-current="page">TRAINER RESUME</li>
            </ol>
        </nav>
    </div>
</div>
<!-- Page Header End -->
<!-- Team Start -->
<section class="section bg-gray">

    <div class="trainerfilter bgc">
        <div class="container ">
            <div class="row">
                <div class="card border-0 bg-transparent rounded-0 mb-4" style="width: 100%;">

                    <!-- 履歷內容開始 -->
                    <div class="row no-gutters">

                        <!-- 教練大頭貼 -->
                        <div class="col-md-6 p-5">
                            <div class="circle-container mx-auto">
                                <img src="~/images/nopersonal.jpg" class="trainer-img" id="trainer-img">
                            </div>
                            <!-- 教練名字 -->
                            <h3 class="card-title text-light" id="trainer-name"></h3>
                            <div class="d-flex align-items-center">

                                <!-- 評分 -->
                                <p class="card-subtitle pb-1 pt-4 mb-2 letter-spacing m-auto">
                                    <img class="star" src="~/images/icon/star.png" alt="">
                                    <img class="star" src="~/images/icon/star.png" alt="">
                                    <img class="star" src="~/images/icon/star.png" alt="">
                                    <img class="star" src="~/images/icon/star.png" alt="">
                                    <img class="star" src="~/images/icon/star_dark.png" alt="">
                                </p>
                            </div>

                            <!-- 社群 -->
                            <div class="d-flex align-items-center mb-2">
                                <p class="card-subtitle letter-spacing m-auto">
                                    <i class="fa-brands fa-square-facebook fa-xl me-2 fc-232323"></i>
                                    <i class="fa-brands fa-linkedin fa-xl me-2 fc-232323"></i>
                                    <i class="fa-brands fa-square-instagram fa-xl fc-232323"></i>
                                </p>
                            </div>
                            <!-- 課程費用 -->
                            <div class="d-flex align-items-center">
                                <p class="coursefee card-subtitle letter-spacing m-auto text-light pt-1 font-weight-bold"
                                   id="coursefee">
                                    課程費用: /hr
                                </p>
                                </p>
                            </div>

                        </div>


                        <div class="col-md-5">
                            <div class="card-body team-wrap pl-5 text-light pt-5">

                                <!-- 專長 -->
                                <div>
                                    <h5 class="d-flex fc-232323">Expertise專長</h5>
                                    <ul id="expertise">
                                    </ul>
                                </div>
                                <hr>
                                <!-- 專業證照 -->
                                <div>
                                    <h5 class="d-flex fc-232323">Certificate專業證照</h5>
                                    <ul id="certificates">
                                    </ul>
                                </div>
                                <hr>
                                <!-- 經歷 -->
                                <div>
                                    <h5 class="d-flex fc-232323">Experience經歷</h5>
                                    <ul id="experience">
                                    </ul>
                                </div>

                            </div>
                        </div>

                    </div>
                    <!-- 教練履歷內容結束 -->
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Section Team End -->
<!-- 我要預約的按鈕開始 -->
<div id="app">
    <div class="btn-1-container" id="gogo">
        <button class="btn btn-1" id="showButton" @@click="toggleCalendar">
            <span class="btn-content">我要預約</span>
            <span class="icon"><i class="fa fa-arrow-right" aria-hidden="true"></i></span>
        </button>
    </div>
    <!-- 我要預約的按鈕結束 -->
    <div class="container mt-5">
        <div class="reservation" id="calendar" v-show="showCalendar">
        </div>
    </div>
</div>
<!-- 預約日期顯示結束 -->
<!-- Section Team End -->
<!-- 教練履歷 -->
<!-- 引入Composition API -->

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // 從URL獲取的Trainer的ID
        var urlParams = new URLSearchParams(window.location.search);
        var trainerId = urlParams.get("id");

        // 使用fetch函數獲取特定Trainer的API數據
        fetch("https://localhost:7011/api/Reservation/" + trainerId)
            .then(function (response) {
                if (!response.ok) {
                    throw new Error("API請求失敗" + response);
                }
                return response.json();
            })
            .then(function (data) {
                // console.log(data);
                // 純粹查教練履歷
                var Photo = data.photo; //照片
                var trainerName = data.trainerName; //教練名字
                var courseFee = data.courseFee; //課程費用
                var expertise = data.expertise; //經歷
                var certificates = data.certificate; //專業證照
                var experience = data.experience; //專長

                // 更新教練照片
                var trainerPhotoElement = document.querySelector("#trainer-img");

                //trainerPhotoElement.onerror = function () {
                //    trainerPhotoElement.src = "./images/nopersonal.jpg";
                //};
                if (Photo) {
                    var trainerImageBase64 = Photo; // 從API獲取的Base64編碼的照片
                trainerPhotoElement.src = "data:image/jpeg;base64," + trainerImageBase64; // 直接將圖像設置為src
                }

                // 更新教練名字
                var trainerNameElement = document.querySelector("#trainer-name");
                trainerNameElement.textContent = trainerName;
                // 课程费用
                var courseFeeElement = document.querySelector("#coursefee");
                courseFeeElement.textContent = "課程費用: " + courseFee + "/hr";

                // 更新專長
                var expertiseElement = document.querySelector("#expertise");
                var expertiseArray = expertise.split(",");
                expertiseArray.forEach(function (field) {
                    var listItem = document.createElement("li");
                    listItem.textContent = field.trim(); // 去除字符串两侧的空格
                    expertiseElement.appendChild(listItem);
                });

                // 更新專業證照
                var certificatesElement = document.querySelector("#certificates");
                var certificatesArray = certificates.split(",");
                certificatesArray.forEach(function (field) {
                    var listItem = document.createElement("li");
                    listItem.textContent = field.trim(); // 去除字符串两侧的空格
                    certificatesElement.appendChild(listItem);
                });

                // 更新經歷
                var experienceElement = document.querySelector("#experience");
                var experienceArray = experience.split(",");
                experienceArray.forEach(function (field) {
                    var listItem = document.createElement("li");
                    listItem.textContent = field.trim(); // 去除字符串两侧的空格
                    experienceElement.appendChild(listItem);
                });


                //以下開始製作預約月曆

            })
            .catch(function (error) {
                // 處裡錯誤訊息
                console.error("API请求失败: " + error.message);
            });

    });

    //  預約周曆
    //const { createApp, ref } = Vue;
    const { ref } = Vue;
    const app = Vue.createApp({
        setup() {
            const showCalendar = ref(false);
            let calendarInstance = null;
            let globalData = null;
            let isDataFetched = false;
            const toggleCalendar = () => {
                showCalendar.value = !showCalendar.value;
                if (showCalendar.value && !isDataFetched) {
                    fetchEventsFromAPI().then(() => { // 從API獲取數據
                        isDataFetched = true; // 獲取數據後將變數設置為 true
                        calendarInstance.render();
                    });
                }
                // 添加滾動到視圖的代碼
                const gogoBlock = document.getElementById("gogo");
                gogoBlock.scrollIntoView({ behavior: "smooth", block: showCalendar.value ? "start" : "end" });
            };

            const initCalendar = () => {
                const calendarEl = document.getElementById('calendar');
                calendarInstance = new FullCalendar.Calendar(calendarEl, {
                    // 設定初始視圖為週視圖
                    initialView: 'timeGridWeek',
                    selectable: true,
                    allDaySlot: false,
                    // 設定語言
                    locale: 'zh-tw',
                    // 設定時間範圍，早上9點到晚上10點
                    slotMinTime: '09:00:00',
                    slotMaxTime: '22:00:00',
                    slotDuration: '01:00:00',  // 這裡設定每個時間格為一小時
                    height: 760,
                    titleFormat: { year: 'numeric' },  // 只顯示年分
                    // 顯示上一週、下一週和今天按鈕
                    headerToolbar: {
                        left: 'prev',
                        center: 'title',
                        right: 'next today'
                    },
                    eventContent: function (arg) {
                        let memberId = arg.event.extendedProps.memberId;
                        let courseStatus = arg.event.extendedProps.courseStatus;

                        if (courseStatus === '進行中' && memberId === 0) {
                            return {
                                html: '<button class="available">尚可預約</button>'
                            };
                        } else if (courseStatus === '進行中' && memberId > 0) {
                            return {
                                html: '<button class="booked">已被預約</button>'
                            };
                        } else {
                            return {
                                html: '<button class="booked">已結束</button>'
                            };
                        }

                    },
                    eventClick: function (info) {
                        let memberId = info.event.extendedProps.memberId;
                        let courseStatus = info.event.extendedProps.courseStatus;
                        if (!memberId && courseStatus === '進行中') {
                            showModal(info.event);
                        }
                    }

                });
                //calendarInstance.render();
            };

            const fetchEventsFromAPI = async () => {
                // 從URL獲取的Trainer的ID
                var urlParams = new URLSearchParams(window.location.search);
                var trainerId = urlParams.get("id");
                
                fetch("https://localhost:7011/api/Reservation/" + trainerId)
                    .then(function (response) {
                        if (!response.ok) {
                            throw new Error("API請求失敗" + response);
                        }
                        return response.json();
                    })
                    .then(function (data) {
                        globalData = data; // 儲存數據到全局變量
                        // 將獲取的事件數據添加到日曆中
                        calendarInstance.addEventSource(data.classes.map(event => ({
                            start: event.startTime,
                            end: event.endTime,
                            extendedProps: {
                                memberId: event.memberId,
                                classId: event.classId,
                                gymId: event.gymId,
                                classTypeId: event.classTypeId,
                                courseStatus: event.courseStatus,
                            }
                        })));

                    })
                    .catch(function (error) {
                        // 處理錯誤情況
                        console.log("找不到預約資料: " + error.message);
                        Swal.fire('錯誤', '此教練尚未開課', 'error');

                    });
            };

            const showModal = (event) => {
                //接收場館
                // 使用fetch、axios或其他HTTP庫從API獲取健身房信息
                var gymId = event.extendedProps.gymId;
                var startTime = event.extendedProps.startTime;
                var endTime = event.extendedProps.endTime;

                // 從獲取到的API數據中找出對應的健身房
                var gymInfo = globalData.gyms.find(gym => gym.gymId === gymId);
                // 獲取教練ID和課程類型ID
                const classTypeId = event.extendedProps.classTypeId;
                //const matchedClassTypeInfo = classTypeData.find(type => type.classTypeId === classTypeId);
                // 放進健身房模擬視窗
                // 使用SweetAlert2显示模态窗口
                Swal.fire({
                    title: '預約資訊',
                    html: `
                                                <div class="row m-0 p-0">
                                                    <div class="col me-0 pe-0" style="text-align: left;">
                                                      <p><strong>場館名稱:</strong><br> ${gymInfo ? gymInfo.gymName : "場館名稱未知"}</p>
                                                      <p><strong>場館電話:</strong><br> ${gymInfo ? gymInfo.phone : "場館電話未知"}</p>
                                                      <p><strong>場館地址:</strong><br>  <span style="white-space: nowrap;">${gymInfo ? gymInfo.address : "場館地址未知"}</span></p>
                                                    </div>
                                                <div class="col m-auto m-0 p-0">
                                                    <img src="data:image/jpeg;base64,${gymInfo ? gymInfo.photo : ''}" alt="場館照片" width="200">
                                                </div>
                                            `,
                    showCancelButton: true,
                    confirmButtonColor: '#F24B88',
                    cancelButtonColor: '#2c3e50',
                    confirmButtonText: '確認預約',
                    cancelButtonText: '取消'
                }).then((result) => {
                    if (result.isConfirmed) {
                        confirmReservation(event);
                    }
                });
            };

            const confirmReservation = (event) => {
                // 隱藏模態視窗
                var modal = document.getElementById("myModal");
                if (modal !== null) {
                    modal.style.display = "none";
                }
                var memberId = 1; //預設 之後要從網站帶入
                // 構建要發送到後端的數據
                const reservationData = {
                    "classId": event.extendedProps.classId,
                    // "trainerId": event.trainerId,
                    // "gymId": event.extendedProps.gymId,
                    "memberId": memberId,  // 還沒設
                    // "startTime": event.startStr,
                    // "endTime": event.endStr,
                    // "buildTime": new Date().toISOString(),
                    // "courseStatus": "進行中"
                };
                //console.log(reservationData);
                // 使用fetch發送預約信息到後端
                fetch("https://localhost:7011/api/Reservation", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reservationData)
                }).then(response => {
                    if (response.ok) {
                        // 成功預約後，更新前端狀態
                        event.setExtendedProp('memberId', memberId);
                        // 重新渲染該事件以反映變化
                        event.remove();
                        calendarInstance.addEvent(event);
                        Swal.fire('成功', '課程預約成功', 'success');
                    } else {
                        Swal.fire('失敗', '預約失敗，請洽客服', 'error');
                    }
                }).catch(error => {
                    console.log("預約資訊傳送失敗請把Api打開!!: " + error.message);
                    Swal.fire('失敗', '預約失敗，請洽客服', 'error');
                });
            };

            // 在掛載後初始化日曆和獲取事件
            const onMounted = () => {
                initCalendar();
                //fetchEventsFromAPI().then(() => {
                //    calendarInstance.render();
                //});
            };

            return {
                showCalendar,
                toggleCalendar,
                onMounted
            };
        },
        mounted() {
            this.onMounted();
        }
    }).mount("#app");

</script>