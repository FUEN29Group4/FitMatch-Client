
@{
    ViewData["Title"] = "PaymentTest";
}

@*  ====== 增加之後待使用 start  ====== *@
<!-- 增加Vue跟axios跟jQuery 函式庫CDN-->
@*<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.js"></script>*@
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.5.0/axios.js"></script>
<script src="https://unpkg.com/vue@3"></script>


@* ====== 原先Html樣式 start ====== *@
<link rel="stylesheet" href="~/css/Mall.css/style.css">
<style>
    .form-control:focus {
        border-color: #86b7fe;
         outline: 0; 
         box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25); 
    }
    .form-control {
        border-radius:5px;
    }
    .accordion-item {
        background-color: #fff; 
       
    }
</style>

<!--Mall的樣式css-->
@*
    <link rel="stylesheet" href="~/css/Mall.css/owl.theme.default.min.css">

    <link rel="stylesheet" href="~/css/Mall.css/owl.carousel.min.css">

    <link rel="stylesheet" href="~/css/Mall.css/remixicon.css">

    <link rel="stylesheet" href="~/css/Mall.css/meanmenu.min.css">

    <link rel="stylesheet" href="~/css/Mall.css/animate.min.css">


    <link rel="stylesheet" href="~/css/Mall.css/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />*@


@*  ======  body start ====== *@
<!-- Page Header Start -->
<div class="container-fluid page-header py-5 mb-5 wow fadeIn" data-wow-delay="0.1s">
    <div class="container text-center py-5">
        <h1 class="display-3 text-white text-uppercase mb-3 animated slideInDown">Checkout</h1>
        <nav aria-label="breadcrumb animated slideInDown">
            <ol class="breadcrumb justify-content-center text-uppercase mb-0">
                <li class="breadcrumb-item"><a class="text-white" href="#">首頁</a></li>
                <li class="breadcrumb-item"><a class="text-white" href="#">商城</a></li>
                <li class="breadcrumb-item"><a class="text-white" href="#">購物車</a></li>
                <li class="breadcrumb-item text-primary active" aria-current="page">結帳流程</li>
            </ol>
        </nav>
    </div>
</div>
<!-- Page Header End -->
<!-- Team Start -->
<div id="app">
    <section class="checkout-area ptb-54 bg-white">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-md-12 ">

                    <!-- 提醒登入的畫面先藏起來 -->
                     @*<div class="log-in-coupon-code">
                        <p>Returning customer? Click here to
                            <a href="my-account.html">
                                Log In
                            </a>
                        </p>
                    </div>*@ 

                    @*<form>
                        <div class="billing-details">
                            <h3 class="title">訂購人資訊</h3>
                            <div class="row">
                                <div class="col-lg-12 col-md-6">
                                    <div class="form-group">
                                        <label>姓名<span class="required">*</span></label>
                                        <div class="col-lg-6 col-md-6">
                                            <input type="text" class="form-control">
                                        </div>
                                    </div>
                                </div>

                                <div class="col-lg-12 col-md-6">
                                    <div class="form-group">
                                        <label>Email <span class="required">*</span></label>
                                        <div class="col-lg-6 col-md-6">
                                            <input type="email" class="form-control">
                                        </div>
                                    </div>
                                </div>

                                <div class="col-lg-12 col-md-6">
                                    <div class="form-group">
                                        <label>電話<span class="required">*</span></label>
                                        <div class="col-lg-6 col-md-6">
                                            <input type="text" class="form-control">
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </form>*@


                    <div class="cart-totals ">
                        @*<div class="card-header">
                            {{order.orderId}}
                            {{order.totalPrice}}
                        </div>*@
                        <div class="card-body">
                            <div class="row mb-2">
                                @*<div class="col-md-6">
                                    <label class="form-label">商店代號</label>
                                    <input type="text" class="form-control" id="MerchantID" v-model="addForm.MerchantID">
                                </div>*@

                                <div class="col-md-6 form-group">
                                <label class="form-label">訂購人</label>
                                    <input type="text" class="form-control" id="MemberName" v-model="addForm.MemberName">
                                </div>



                                <div class="col-md-6">
                                    <label class="form-label">訂單編號</label>
                                    <input type="text" class="form-control" id="MerchantOrderNo" v-model="addForm.MerchantOrderNo">
                                </div>
                            </div>
                            <div class="row mb-2">
                                @*<div class="col-md-6">
                                    <label class="form-label">商品說明</label>
                                    <input type="text" class="form-control" id="ItemDesc" v-model="addForm.ItemDesc">
                                </div>*@

                                <div class="col-md-6">
                                    <label class="form-label">電子信箱</label>
                                    <input type="text" class="form-control" id="Email" v-model="addForm.Email">
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">商品金額</label>
                                    <input type="text" class="form-control" id="Amt" v-model="addForm.Amt">
                                </div>
                            </div>
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label">電話</label>
                                    <input type="text" class="form-control" id="Phone" v-model="addForm.Phone">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">繳費有效期限</label>
                                <input type="text" class="form-control" id="ExpireDate" v-model="addForm.ExpireDate">
                            </div>
                        </div>

                            @*<div class="row mb-2">
                                 <div class="col-md-6">
                                    <label class="form-label">支付完成返回網址</label>
                                    <input type="text" class="form-control" id="ReturnURL" v-model="addForm.ReturnURL">
                                </div>*@
 
                                @*<div class="col-md-6">
                                    <label class="form-label">商店取號網址</label>
                                    <input type="text" class="form-control" id="CustomerURL" v-model="addForm.CustomerURL">
                                </div>*@
                            @*</div>*@
                            @*<div class="row mb-2">
                               <div class="col-md-6">
                                    <label class="form-label">支付通知網址</label>
                                    <input type="text" class="form-control" id="NotifyURL" v-model="addForm.NotifyURL">
                                </div>*@ 
                                <div class="col-md-6">
                                    @*<label class="form-label">返回商店網址</label>
                                    <input type="text" class="form-control" id="ClientBackURL" v-model="addForm.ClientBackURL">*@

                                    <label class="form-label" type="hidden"  id="ClientBackURL" v-model="addForm.ClientBackURL"></label>                                 

                                </div>
                            </div>
                        </div>

                        <ul style="list-style-type:none">
                            <li>
                               @*  <button type="button" class="btn btn-primary" v-on:click="SendToNewebPay('UNIONPAY')">前往付款</button> *@
                            </li>

                            <!--<li class="accordion-item">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input"
                                           id="ship-differents-address">-->
                                    @*<label class="form-check-label" for="ship-different-address">
                                        我同意<a href="terms-conditions.html">相關事項</a>**@
                                    @*</label>*@
                                <!--</div>
                            </li>-->
                        </ul>
                    </div>
                </div>


                @* 畫面右邊 *@
                <div class="col-lg-4 col-md-12">
                    <div class="cart-totals">
                        <h3 class="cart-checkout-title">前往結帳</h3>
                        <div class="text-center">

                            <btn type="button" class="btn btn-primary" v-on:click="SendToNewebPay('UNIONPAY')"
                               style="min-width: 250px; margin: auto;">
                                結帳
                            </btn>
                        </div>
                        
                        

                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
<!-- Team End -->



<script>
   
        const app = Vue.createApp({
            data() {

                return {
                    //orders資料
                    order: [],  // 存儲單一訂單數據

                    // 表單資料
                    addForm: {
                        MerchantID: '@ViewData["MerchantID"]' //商品代號
                        , MerchantOrderNo: '@ViewData["MerchantOrderNo"]'
                        , ItemDesc: '商品'
                        , Amt: '100'

                        , ExpireDate: '@ViewData["ExpireDate"]'
                        // , ReturnURL: '@ViewData["ReturnURL"]'
                        // , CustomerURL: '@ViewData["CustomerURL"]'
                       //  , NotifyURL: '@ViewData["NotifyURL"]'
                        , ClientBackURL: '@ViewData["ClientBackURL"]'
                        , Email: 'xxxx@gmail.com'
                        , MemberName: '蔡彤彤'
                    }
                }
            },
            //從URL中獲取的orderID
            async mounted() {

                try {
                    //從URL中獲取的orderID
                    var urlParams = new URLSearchParams(window.location.search);
                    var OrderID = urlParams.get("id")

                    //抓第一個API純order的資訊
                    // 使用 fetch 來獲取商品數據
                    const response = await fetch(`https://localhost:7011/api/OrderAPI/` + OrderID);

                    this.order = await response.json();

                    // 更新表單資料的Amt/ erchantOrderNo ...等orderviewmodel中的屬性
                    this.addForm.Amt = this.order.totalPrice.toString();
                    this.addForm.MerchantOrderNo = this.order.orderId.toString();
                 

                    //抓第二個API加上顧客的資訊
            const response2 = await fetch(`https://localhost:7011/api/OrderAPI/orderviewmodel?id=${OrderID}`);

                    this.order2 = await response2.json();
                    this.addForm.Email = this.order2.email.toString();
                    this.addForm.MemberName = this.order2.memberName.toString();
                    this.addForm.Phone = this.order2.phone.toString();

           



                } catch (error) {
                    console.error('獲取資料錯誤：', error);
                }


    

            },
            methods: {

                // 傳送至藍新金流
                SendToNewebPay(ChannelID) {
                    var self = this;

                    // 組合表單資料
                    var postData = {};
                    postData['ChannelID'] = ChannelID;
                    postData['MerchantID'] = self.addForm.MerchantID;
                    postData['MerchantOrderNo'] = self.addForm.MerchantOrderNo;
                    postData['ItemDesc'] = self.addForm.ItemDesc;
                    postData['Amt'] = self.addForm.Amt;

                    postData['ExpireDate'] = self.addForm.ExpireDate;
                    // postData['ReturnURL'] = self.addForm.ReturnURL;
                    // postData['CustomerURL'] = self.addForm.CustomerURL;
                    // postData['NotifyURL'] = self.addForm.NotifyURL;
                    postData['ClientBackURL'] = self.addForm.ClientBackURL;
                    postData['Email'] = self.addForm.Email;

                    // 使用 jQuery Ajax 傳送至後端
                    $.ajax({
                        url: '@Url.Content("~/Order/SendToNewebPay")',
                        method: 'POST',
                        dataType: 'json',
                        data: { inModel: postData, __RequestVerificationToken: $('@Html.AntiForgeryToken()').val() },
                        success: function(returnObj) {
                            // 呼叫藍新金流 API
                            const form = document.createElement('form');
                            form.method = 'post';
                            form.action = 'https://ccore.newebpay.com/MPG/mpg_gateway';//藍新金流驗證網址(測試環境)

                            for (const key in returnObj) {
                                if (returnObj.hasOwnProperty(key)) {
                                    const hiddenField = document.createElement('input');
                                    hiddenField.type = 'hidden';
                                    hiddenField.name = key;
                                    hiddenField.value = returnObj[key];
                                    form.appendChild(hiddenField);
                                }
                            }
                            document.body.appendChild(form);
                            form.submit();
                        },
                        error: function(err) {
                            alert(err.status + " " + err.statusText + '\n' + err.responseText);
                        }
                    });
                },




            }
        });
        const vm = app.mount('#app');
</script>

