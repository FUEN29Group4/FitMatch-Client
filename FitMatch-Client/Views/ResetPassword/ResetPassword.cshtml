
@{
    Layout = null;
    ViewData["Title"] = "ResetPassword";
}

<h1>ResetPassword</h1>

<form id="reset-password-form">
    <label for="newPassword">新密碼:</label>
    <input type="password" id="newPassword" name="newPassword" required>

    <label for="confirmPassword">確認新密碼:</label>
    <input type="password" id="confirmPassword" name="confirmPassword" required>

    <input type="hidden" id="token" name="token">

    <button type="submit">提交</button>
</form>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (token) {
            document.getElementById('token').value = token;
        }

        const form = document.getElementById('reset-password-form');
        form.addEventListener('submit', function (event) {
            event.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('兩次輸入的密碼不一致.');
                return;
            }

            const payload = {
                newPassword: newPassword,
                token: token
            };

            fetch('https://localhost:7011/api/Login/resetPassword', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            })
                .then(response => {
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.includes("application/json")) {
                        return response.json();
                    }
                    return response.text();
                })
                .then(data => {
                    if (typeof data === 'object' && data !== null) {
                        if (data.success) {
                            alert('密碼重置成功');
                            window.location.href = "Login/Login";
                        } else {
                            alert('密碼重置失敗');
                        }
                    } else {
                        alert(data);  // 當回應是純文本時
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert('An error occurred while resetting your password.');
                });
        });
    });

</script>